generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  INSTRUCTOR
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CourseType {
  FREE
  PAID
}

enum CouponTarget {
  ALL
  COURSE
  SPECIALIZATION
}

// ─── USER ──────────────────────────────
model User {
  id        Int       @id @default(autoincrement())
  fullname  String    @db.VarChar(50)
  email     String    @unique
  password  String    @db.VarChar(100)
  avatar    String    @default("https://res.cloudinary.com/dtaawt3ej/image/upload/v1747292486/q9lmgugyqgrm7q5voatw.jpg")
  gender    Gender?
  dob       DateTime? @db.Date
  address   String?
  role      UserRole  @default(USER)
  phone     String?

  isVerified             Boolean   @default(false)
  resetOtp               String?
  resetOtpExpires        DateTime?
  verificationOtp        String?
  verificationOtpExpires DateTime?

  refreshToken        String?   @db.Text
  refreshTokenExpires DateTime?

  // Relations
  instructorApplications InstructorApplication[]
  
  courses                Course[]
  CourseRating CourseRating[]
  CourseView CourseView[]

  Coupon Coupon[]
  CouponUsage CouponUsage[]
  DiscountCampaign DiscountCampaign[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── INSTRUCTOR APPLICATION ──────────────────────────────
model InstructorApplication {
  id         Int               @id @default(autoincrement())
  userId     Int
  experience String?            @db.Text
  bio        String?            @db.Text
  status     ApplicationStatus  @default(PENDING)
  reviewedAt DateTime?
  reviewedBy Int?

  // Relations
  user                     User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  applicationSpecializations ApplicationSpecialization[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── SPECIALIZATION ──────────────────────────────
model Specialization {
  id       Int     @id @default(autoincrement())
  name     String  @unique @db.VarChar(100)
  desc     String? @db.Text

  // Relations
  applicationSpecializations ApplicationSpecialization[]
  courseSpecializations      CourseSpecialization[]

  Coupon Coupon[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── JUNCTION: InstructorApplication ↔ Specialization ──────────────────────────────
model ApplicationSpecialization {
  applicationId    Int
  specializationId Int

  application      InstructorApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  specialization   Specialization        @relation(fields: [specializationId], references: [id], onDelete: Cascade)

  @@id([applicationId, specializationId])
}

// ─── COURSE ──────────────────────────────
model Course {
  id           Int        @id @default(autoincrement())
  title        String     @db.VarChar(150)
  description  String?    @db.Text
  thumbnail    String?    // Cloudinary URL
  price        Float      @default(0)
  type         CourseType @default(FREE)
  isPublished  Boolean    @default(false)
  viewCount    Int        @default(0)
  duration     Int        @default(0) // Tổng thời lượng (phút)

  // Relations
  instructorId Int
  instructor   User        @relation(fields: [instructorId], references: [id], onDelete: Cascade)

  specializations CourseSpecialization[]

  courseRating CourseRating[]
  courseView CourseView[]
  chapter Chapter[]
  
  Coupon Coupon[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// ─── COURSE VIEW ──────────────────────────────
model CourseView {
  id        Int      @id @default(autoincrement())
  courseId  Int
  userId    Int?
  ipAddress String?
  viewedAt  DateTime @default(now())

  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId, ipAddress])
}

// ─── CHAPTER ──────────────────────────────
model Chapter {
  id          Int       @id @default(autoincrement())
  title       String    @db.VarChar(150)
  description String?   @db.Text
  orderIndex  Int       @default(0)
  duration    Int       @default(0) // Tổng thời lượng (phút)

  // Relations
  courseId Int
  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons  Lesson[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, orderIndex]) // mỗi course có thứ tự chapter riêng
}

// ─── LESSON ──────────────────────────────
model Lesson {
  id          Int       @id @default(autoincrement())
  title       String    @db.VarChar(150)
  content     String?   @db.Text     // HTML content
  videoUrl    String?   // Cloudinary URL
  orderIndex  Int       @default(0)
  duration    Int       @default(0) // Tổng thời lượng (phút)

  // Relations
  quizzes Quiz[]

  chapterId   Int?
  chapter     Chapter?   @relation(fields: [chapterId], references: [id], onDelete: SetNull)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// ─── JUNCTION: Course ↔ Specialization ──────────────
model CourseSpecialization {
  courseId         Int
  specializationId Int

  course           Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  specialization   Specialization @relation(fields: [specializationId], references: [id], onDelete: Cascade)

  @@id([courseId, specializationId])
}

// ─── QUIZ ──────────────────────────────
model Quiz {
  id        Int       @id @default(autoincrement())
  title     String     @db.VarChar(150)
  lessonId  Int        
  lesson    Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions Question[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

// ─── QUESTION ──────────────────────────────
model Question {
  id           Int       @id @default(autoincrement())
  questionText String     @db.Text
  quizId       Int
  quiz         Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options      Option[]   // Nhiều lựa chọn (multiple choice)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── OPTION ──────────────────────────────
model Option {
  id          Int      @id @default(autoincrement())
  text        String   @db.VarChar(255)
  isCorrect   Boolean  @default(false)
  questionId  Int
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

// ─── COURSE RATING ──────────────────────────────
model CourseRating {
  id        Int      @id @default(autoincrement())
  rating    Int      @db.TinyInt // giá trị 1–5

  // Relations
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId  Int
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId]) // mỗi user chỉ được rate 1 lần / course
}

model Coupon {
  id          Int       @id @default(autoincrement())
  code        String    @unique
  percentage  Float     @default(0)
  maxUsage    Int?
  usedCount   Int       @default(0)
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  target      CouponTarget  @default(ALL) // ALL, COURSE, SPECIALIZATION
  createdById Int
  createdBy   User      @relation(fields: [createdById], references: [id], onDelete: Cascade)

  courseId    Int?
  course      Course?   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  specializationId Int?  // nếu coupon áp dụng cho specialization
  specialization   Specialization? @relation(fields: [specializationId], references: [id], onDelete: Cascade)

  CouponUsage CouponUsage[]
  DiscountCampaign DiscountCampaign[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model CouponUsage {
  id         Int      @id @default(autoincrement())
  couponId   Int
  userId     Int
  usedAt     DateTime @default(now())

  coupon     Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([couponId, userId])
}

model DiscountCampaign {
  id          Int             @id @default(autoincrement())
  title       String
  description String?
  percentage  Float
  courseId    Int?
  specializationId Int?
  startsAt    DateTime
  endsAt      DateTime
  isActive    Boolean @default(true)
  
  coupons     Coupon[]

  createdById Int
  createdBy   User @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}